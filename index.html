<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Norway Pathfinder v3.0</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        #app { max-width: 800px; margin: auto; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; height: 90vh; }
        h1 { text-align: center; color: #333; margin: 20px 0; }
        #chat-log { flex-grow: 1; overflow-y: auto; padding: 20px; border-bottom: 1px solid #ddd; border-top: 1px solid #ddd; }
        .message { margin-bottom: 15px; padding: 10px 15px; border-radius: 18px; line-height: 1.5; max-width: 75%; }
        .user { background: #007bff; color: white; margin-left: auto; text-align: left; }
        .ai { background: #e9ebee; color: #000; text-align: left; }
        .loader { text-align: center; color: #888; }
        pre { background: #222; color: #eee; padding: 10px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; }
        #input-area { display: flex; padding: 20px; }
        #user-input { flex-grow: 1; border: 1px solid #ccc; border-radius: 18px; padding: 10px 15px; font-size: 16px; }
        #send-button { background: #007bff; color: white; border: none; border-radius: 18px; padding: 10px 20px; margin-left: 10px; cursor: pointer; font-size: 16px; }
        #send-button:disabled { background: #aaa; }
    </style>
</head>
<body>

    <div id="app">
        <h1>Norway Pathfinder v3.0</h1>
        <div id="chat-log">
            </div>
        <div id="input-area">
            <input type="text" id="user-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É (–Ω–∞–ø—Ä. [HELP])">
            <button id="send-button">‚ñ∫</button>
        </div>
    </div>

    <script>
        // --- –ù–∞—á–∞–ª–æ –õ–æ–≥–∏–∫–∏ v3.0 ---

        // 1. –í–ê–®–ò –ö–õ–Æ–ß–ò –ò –ù–ê–°–¢–†–û–ô–ö–ò
        const API_KEY = "AIzaSyCGHGlBEdV0eTZQZsw8ZxxEyY7k8P3EGOY"; // üî¥ –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π –∫–ª—é—á
        const API_URL = `https://us-central1-aiplatform.googleapis.com/v1/projects/Gen-lang-client-0805642856/locations/us-central1/publishers/google/models/gemini-1.0-pro:generateContent?key=${API_KEY}`;
        
        // –≠—Ç–æ –Ω–∞—à "–ë–ª–æ–∫–Ω–æ—Ç" –≤ –ø–∞–º—è—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞
        const STORAGE_KEY = "norwayRoadmapV2_2"; 

        // –≠—Ç–æ –Ω–∞—à–∞ "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –Ω–∞ —Å—Ç–µ–Ω–µ"
        const SYSTEM_PROMPT = `
# –†–û–õ–¨: –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–´–ô –°–¢–†–ê–¢–ï–ì –ò–ù–¢–ï–ì–†–ê–¶–ò–ò (NORWAY-PATHFINDER v2.2)

–Ø ‚Äî AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç (v2.2), —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏ –≤–µ–¥–µ–Ω–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–æ—Ä–æ–∂–Ω—ã—Ö –∫–∞—Ä—Ç (Roadmap) –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –ù–æ—Ä–≤–µ–≥–∏–∏.

## –ö–õ–Æ–ß–ï–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: STATE-HANDLER (JSON-–ü–ê–ú–Ø–¢–¨)
–Ø –Ω–µ –∏–º–µ—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –ø–∞–º—è—Ç–∏. –ú–æ—è –ø–∞–º—è—Ç—å ‚Äî —ç—Ç–æ JSON-—Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –º–Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ. –Ø –Ω–µ –º–æ–≥—É "–º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å" —Å–∞–π—Ç—ã –∏–ª–∏ "–Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å" –≤–∞–º –æ –¥–∞—Ç–∞—Ö. –Ø –º–æ–≥—É *—Ç–æ–ª—å–∫–æ* –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à JSON, –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É –∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å *–Ω–æ–≤—ã–π* JSON.

**–¶–∏–∫–ª —Ä–∞–±–æ—Ç—ã:**
1.  **–í—ã (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):** (–≠—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç) –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç–µ –º–Ω–µ –º–æ–π –ø–æ—Å–ª–µ–¥–Ω–∏–π JSON-—Ñ–∞–π–ª (v2.2) –∏ –æ–¥–Ω—É –∫–æ–º–∞–Ω–¥—É.
2.  **–Ø (–ê–≥–µ–Ω—Ç):** –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é JSON, –≤—ã–ø–æ–ª–Ω—è—é –∫–æ–º–∞–Ω–¥—É.
3.  **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
    * –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ *–º–µ–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ* (–Ω–∞–ø—Ä., \`[–ó–ê–í–ï–†–®–ò–¢–¨_–¶–ï–õ–¨]\`), —è –≤–æ–∑–≤—Ä–∞—â–∞—é **–ù–û–í–´–ô** JSON-—Ñ–∞–π–ª.
    * –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ *–∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç* (–Ω–∞–ø—Ä., \`[–ü–û–ò–°–ö:]\`), —è –≤–æ–∑–≤—Ä–∞—â–∞—é –æ—Ç–≤–µ—Ç (JSON –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è).
4.  **–í—ã (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å):** (–≠—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç) –°–æ—Ö—Ä–∞–Ω—è–µ—Ç–µ –Ω–æ–≤—ã–π JSON –¥–ª—è –Ω–∞—à–µ–≥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–µ–∞–Ω—Å–∞.

---

## –ú–û–î–£–õ–¨ 1: –°–¢–†–£–ö–¢–£–†–ê JSON (ROADMAP v2.2)
*–í—ã –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û —Å —ç—Ç–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π JSON.*
\`\`\`json
{
  "profile": { "name": null, "status": null, "location": "Trondheim", "languages": { "norsk": {"level": "B1", "last_assessed": "2025-10-01"}, "english": {"level": "C1", "last_assessed": "2025-01-01"} }, "skills": ["Engineering"], "main_goals": ["Get permanent job"] },
  "roadmap": { "version": 2.2, "last_updated": "YYYY-MM-DDTHH:MM:SSZ" },
  "goals": [
    { "id": "1.1", "category": "education", "title": "–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫—É—Ä—Å Norsk B2", "status": "active", "priority": "high", "due_date": "2026-03-31", "depends_on": null, "activates_on_complete": ["2.1"], "notes_and_risks": "Voksenoppl√¶ring –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –æ—á–µ—Ä–µ–¥—å." },
    { "id": "2.1", "category": "career", "title": "–ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç—ã –∏–Ω–∂–µ–Ω–µ—Ä–æ–º (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ B2)", "status": "pending", "priority": "high", "due_date": null, "depends_on": "1.1", "activates_on_complete": null, "notes_and_risks": null }
  ]
}
\`\`\`

---

## –ú–û–î–£–õ–¨ 2: –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–û–ú–ê–ù–î (v2.2)
*–í–∞—à–∞ –∑–∞–¥–∞—á–∞ - –ø–æ–ª—É—á–∏—Ç—å JSON –∏ –∫–æ–º–∞–Ω–¥—É, –∏ –≤–µ—Ä–Ω—É—Ç—å –æ—Ç–≤–µ—Ç. –ï—Å–ª–∏ JSON –º–µ–Ω—è–µ—Ç—Å—è, –≤—ã –û–ë–Ø–ó–ê–ù–´ –≤–µ—Ä–Ω—É—Ç—å –Ω–æ–≤—ã–π JSON –≤ –±–ª–æ–∫–µ \`\`\`json ... \`\`\`.*

* \`[–ù–ê–ß–ê–¢–¨_–ö–ê–†–¢–£]\`
* \`[–ó–ê–í–ï–†–®–ò–¢–¨_–¶–ï–õ–¨: <ID>]\`
* \`[–î–û–ë–ê–í–ò–¢–¨_–¶–ï–õ–¨]\`
* \`[–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨_–¶–ï–õ–¨: <ID>]\`
* \`[–ü–û–ò–°–ö: <–ö–∞—Ç–µ–≥–æ—Ä–∏—è> <–ó–∞–ø—Ä–æ—Å>]\`
* \`[–≠–ö–°–ü–û–†–¢_–ö–ê–†–¢–´: MD]\`
* \`[–≠–ö–°–ü–û–†–¢_–ö–ê–†–¢–´: JSON]\`
* \`[HELP]\`
`;

        // 2. –≠–õ–ï–ú–ï–ù–¢–´ –ò–ù–¢–ï–†–§–ï–ô–°–ê
        const chatLog = document.getElementById('chat-log');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');

        // 3. –§–£–ù–ö–¶–ò–ò –ü–ê–ú–Ø–¢–ò (localStorage)
        function getRoadmap() {
            return localStorage.getItem(STORAGE_KEY);
        }

        function saveRoadmap(jsonString) {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
                JSON.parse(jsonString); 
                localStorage.setItem(STORAGE_KEY, jsonString);
                console.log("–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ JSON.");
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: –ø–æ–ª—É—á–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON", e);
            }
        }
        
        // 4. –§–£–ù–ö–¶–ò–ò –ß–ê–¢–ê
        function addMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Markdown –≤ HTML –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            let formattedMessage = message.replace(/\n/g, '<br>'); // –ù–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏
            // –ë–ª–æ–∫–∏ –∫–æ–¥–∞
            formattedMessage = formattedMessage.replace(/```json\s*([\s\S]*?)\s*```/g, '<pre>$1</pre>');
            formattedMessage = formattedMessage.replace(/```\s*([\s\S]*?)\s*```/g, '<pre>$1</pre>');
            // –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
            formattedMessage = formattedMessage.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            messageDiv.innerHTML = formattedMessage;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight; // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        }

        function showLoader() {
            sendButton.disabled = true;
            userInput.disabled = true;
            const loaderDiv = document.createElement('div');
            loaderDiv.classList.add('message', 'ai', 'loader');
            loaderDiv.id = 'loader';
            loaderDiv.innerText = "–î—É–º–∞—é...";
            chatLog.appendChild(loaderDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function hideLoader() {
            sendButton.disabled = false;
            userInput.disabled = false;
            const loader = document.getElementById('loader');
            if (loader) {
                loader.remove();
            }
            userInput.focus();
        }

        // 5. –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø (–í—ã–∑–æ–≤ API)
        async function handleUserInput() {
            const command = userInput.value.trim();
            if (command === "") return;

            addMessage(command, 'user');
            userInput.value = "";
            showLoader();

            // === –í–æ—Ç "–º–∞–≥–∏—è" v3.0 ===
            let fullPrompt = SYSTEM_PROMPT;
            
            const currentJson = getRoadmap();
            if (currentJson) {
                fullPrompt += "\n\n## –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï (JSON):\n" + currentJson;
            } else {
                fullPrompt += "\n\n## –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï (JSON):\n*JSON –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω. –û–∂–∏–¥–∞–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ [–ù–ê–ß–ê–¢–¨_–ö–ê–†–¢–£].*";
            }
            
            fullPrompt += "\n\n## –ù–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê –û–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:\n" + command;
            // ==========================

            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –í–°–ï —ç—Ç–æ –≤ Gemini
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: fullPrompt }] }],
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`–û—à–∏–±–∫–∞ API: ${response.status} ${response.statusText}. –û—Ç–≤–µ—Ç: ${errorBody}`);
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0].content) {
                    throw new Error("–ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API.");
                }

                const aiResponseText = data.candidates[0].content.parts[0].text;
                
                hideLoader();
                addMessage(aiResponseText, 'ai');

                // === –ú–∞–≥–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è "–ë–ª–æ–∫–Ω–æ—Ç–∞" ===
                const jsonRegex = /```json\s*([\s\S]*?)\s*```/; 
                const match = aiResponseText.match(jsonRegex);

                if (match && match[1]) {
                    saveRoadmap(match[1]);
                }
                
            } catch (error) {
                console.error(error);
                hideLoader();
                addMessage(`**–û—à–∏–±–∫–∞:** ${error.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à API-–∫–ª—é—á, –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ª–∏–º–∏—Ç—ã API.`, 'ai');
            }
        }

        // 6. –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï –°–û–ë–´–¢–ò–ô
        sendButton.addEventListener('click', handleUserInput);
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleUserInput();
            }
        });

        // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        addMessage("–ü—Ä–∏–≤–µ—Ç! –Ø Pathfinder v3.0. –í–∞—à–∞ '–ø–∞–º—è—Ç—å' (JSON) —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ. –ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã `[HELP]` –∏–ª–∏ `[–ù–ê–ß–ê–¢–¨_–ö–ê–†–¢–£]`.", 'ai');

        // --- –ö–æ–Ω–µ—Ü –õ–æ–≥–∏–∫–∏ v3.0 ---
    </script>

</body>
</html>
